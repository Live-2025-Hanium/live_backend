name: PR Test Coverage

on:
  pull_request:
    types: [opened, synchronize, reopened]
  
permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test-coverage:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost -uroot -proot"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: âœ… ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì„œë¸Œëª¨ë“ˆ í¬í•¨)
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.CONFIG_REPO_PAT }}
      
      - name: ğŸ”„ live-configë¥¼ ìµœì‹  Masterë¡œ ì—…ë°ì´íŠ¸
        run: |
          cd live-config
          git checkout Master
          git pull origin Master
          cd ..
      
      - name: ğŸ“ ì„¤ì • yml íŒŒì¼ë“¤ ë³µì‚¬
        run: |
          mkdir -p ./src/main/resources
          cp live-config/application-dev.yml ./src/main/resources/
          cp live-config/application-test.yml ./src/main/resources/
          cp live-config/common.yml ./src/main/resources/
          mkdir -p ./src/test/resources
          cp live-config/application-test.yml ./src/test/resources/
          cp live-config/common.yml ./src/test/resources/
      
      - name: â˜• JDK 21 ì„¤ì •
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: âœ… gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew
      
      - name: ğŸ” MySQL ì„œë¹„ìŠ¤ ì—°ê²° ëŒ€ê¸°
        run: |
          echo "MySQL ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          for i in {1..30}; do
            if mysqladmin ping -h127.0.0.1 -P3306 -uroot -proot --silent; then
              echo "âœ… MySQL ì—°ê²° ì„±ê³µ!"
              break
            fi
            echo "MySQL ì—°ê²° ëŒ€ê¸° ì¤‘... ($i/30)"
            sleep 2
          done
      
      - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„±
        run: ./gradlew clean test jacocoTestReport -Pprofile=test
        
      - name: ğŸ“Š JaCoCo Coverage Comment
        uses: madrapps/jacoco-report@v1.7.1
        with:
          paths: ${{ github.workspace }}/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 80
          min-coverage-changed-files: 80
          title: ğŸ“Š ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
          update-comment: true
          
      - name: ğŸ“ˆ ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ ì¶œë ¥
        run: |
          echo "## ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìš”ì•½"
          echo ""
          echo "JaCoCo í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ê°€ PR ì½”ë©˜íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo ""
          echo "### ğŸ“ ë³´ê³ ì„œ ìœ„ì¹˜"
          echo "- XML: build/reports/jacoco/test/jacocoTestReport.xml"
          echo "- HTML: build/reports/jacoco/test/html/index.html"
          
      - name: ğŸ’¾ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: jacoco-coverage-report
          path: build/reports/jacoco/test/
          
      - name: âœ… ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ì²´í¬
        run: ./gradlew jacocoTestCoverageVerification