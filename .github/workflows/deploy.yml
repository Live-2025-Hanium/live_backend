name: Spring Boot Gradle CI/CD ë°°í¬

on:
  push:
    branches: [ "develop", "test/ci" ]
  repository_dispatch:
    types: [config-updated]  # live-configì—ì„œ íŠ¸ë¦¬ê±°
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±°
    inputs:
      reason:
        description: 'ë°°í¬ ì‚¬ìœ '
        required: false
        default: 'ìˆ˜ë™ ë°°í¬'

env:
  PROJECT_NAME: live-backend
  AWS_REGION: ap-northeast-2
  S3_BUCKET_NAME: lively-s3-bucket
  CODE_DEPLOY_APPLICATION_NAME: live-codedeploy
  CODE_DEPLOY_DEPLOYMENT_GROUP_NAME: live-codedeploy-group

permissions:
  contents: read

jobs:
  # develop ë¸Œëœì¹˜ push ë˜ëŠ” config ì—…ë°ì´íŠ¸ ì‹œ ì‹¤í–‰
  deploy:
    runs-on: ubuntu-latest

    # MySQLê³¼ Redis ì„œë¹„ìŠ¤ ì¶”ê°€
    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost -uroot -proot"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“‹ ë°°í¬ ì‚¬ìœ  ì¶œë ¥
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸ”„ Config ì—…ë°ì´íŠ¸ë¡œ ì¸í•œ ìë™ ë°°í¬"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ–±ï¸ ìˆ˜ë™ ë°°í¬: ${{ github.event.inputs.reason }}"
          else
            echo "ğŸ“ ì½”ë“œ ë³€ê²½ìœ¼ë¡œ ì¸í•œ ìë™ ë°°í¬"
          fi

      - name: âœ… ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì„œë¸Œëª¨ë“ˆ í¬í•¨)
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.CONFIG_REPO_PAT }}

      - name: ğŸ”„ live-configë¥¼ ìµœì‹  Masterë¡œ ì—…ë°ì´íŠ¸
        run: |
          cd live-config
          git checkout Master
          git pull origin Master
          cd ..

      - name: ğŸ“ ì„¤ì • yml íŒŒì¼ë“¤ ë³µì‚¬
        run: |
          mkdir -p ./src/main/resources
          cp live-config/application-dev.yml ./src/main/resources/
          cp live-config/common.yml ./src/main/resources/
          mkdir -p ./src/test/resources
          cp live-config/application-test.yml ./src/test/resources/
          cp live-config/common.yml ./src/test/resources/

      - name: â˜• JDK 21 ì„¤ì •
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: âœ… gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: ğŸ” MySQL ì„œë¹„ìŠ¤ ì—°ê²° ëŒ€ê¸°
        run: |
          echo "MySQL ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          for i in {1..30}; do
            if mysqladmin ping -h127.0.0.1 -P3306 -uroot -proot --silent; then
              echo "âœ… MySQL ì—°ê²° ì„±ê³µ!"
              break
            fi
            echo "MySQL ì—°ê²° ëŒ€ê¸° ì¤‘... ($i/30)"
            sleep 2
          done

      - name: âš™ï¸ JAR íŒŒì¼ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ í¬í•¨)
        run: ./gradlew clean build -Pprofile=test

      - name: ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: docker build -t live-backend:latest .

      - name: ğŸ“¦ Docker ì´ë¯¸ì§€ë¥¼ tar íŒŒì¼ë¡œ ì €ì¥
        run: docker save live-backend:latest -o live-backend.tar

      - name: ğŸ›  ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ë“¤ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x scripts/*.sh

      - name: ğŸ” AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ì¤€ë¹„ (ZIP íŒŒì¼ ìƒì„±)
        run: |
          mkdir deploy
          cp appspec.yml deploy/
          cp docker-compose.blue.yml deploy/
          cp docker-compose.green.yml deploy/
          cp live-backend.tar deploy/
          cp -r scripts deploy/
          zip -r -qq app.zip deploy/

      - name: ğŸ” ZIP íŒŒì¼ ë‚´ìš© í™•ì¸
        run: unzip -l app.zip

      - name: â˜ï¸ S3ì— ì—…ë¡œë“œ
        run: |
          aws s3 cp app.zip s3://${{ env.S3_BUCKET_NAME }}/${{ github.sha }}.zip

      - name: ğŸš€ CodeDeploy ë°°í¬ ìƒì„±
        run: |
          aws deploy create-deployment \
            --application-name ${{ env.CODE_DEPLOY_APPLICATION_NAME }} \
            --deployment-group-name ${{ env.CODE_DEPLOY_DEPLOYMENT_GROUP_NAME }} \
            --deployment-config-name CodeDeployDefault.AllAtOnce \
            --s3-location bucket=${{ env.S3_BUCKET_NAME }},key=${{ github.sha }}.zip,bundleType=zip
