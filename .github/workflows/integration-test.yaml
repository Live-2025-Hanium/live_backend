name: Integration Test

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
# 1. PRì— 'run-integration-test' ë¼ë²¨ì´ ì¶”ê°€ë  ë•Œ
# 2. ë¼ë²¨ì´ ìˆëŠ” PRì— ìƒˆë¡œìš´ ì»¤ë°‹ì´ pushë  ë•Œ
# ì£¼ì˜: PRì´ mergeë  ë•ŒëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ (deploy.yamlì—ì„œ ì‹¤í–‰)
on:
  pull_request:
    types: [ labeled, synchronize ]
    branches: [ "develop", "main", "master" ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  integration-test:
    # 1. ë¼ë²¨ì„ ë¶™ì˜€ì„ ë•Œ (labeled ì´ë²¤íŠ¸)
    # 2. ë¼ë²¨ì´ ìˆëŠ” ìƒíƒœì—ì„œ ìƒˆë¡œìš´ ì»¤ë°‹ì´ í‘¸ì‹œë˜ì—ˆì„ ë•Œ (synchronize ì´ë²¤íŠ¸)
    if: |
      github.event_name == 'pull_request' && 
      contains(github.event.pull_request.labels.*.name, 'run-integration-test') &&
      (github.event.action == 'labeled' || github.event.action == 'synchronize') &&
      github.event.pull_request.merged != true
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost -uroot -proot"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: âœ… ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì„œë¸Œëª¨ë“ˆ í¬í•¨)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.CONFIG_REPO_PAT }}
      
      - name: ğŸ”„ live-configë¥¼ ìµœì‹  Masterë¡œ ì—…ë°ì´íŠ¸
        run: |
          cd live-config
          git checkout Master
          git pull origin Master
          cd ..
      
      - name: ğŸ“ ì„¤ì • yml íŒŒì¼ë“¤ ë³µì‚¬
        run: |
          mkdir -p ./src/main/resources
          cp live-config/application-dev.yml ./src/main/resources/
          cp live-config/application-test.yml ./src/main/resources/
          cp live-config/common.yml ./src/main/resources/
          mkdir -p ./src/test/resources
          cp live-config/application-test.yml ./src/test/resources/
          cp live-config/common.yml ./src/test/resources/
      
      - name: â˜• JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: âœ… gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew
      
      - name: ğŸ” MySQL ì„œë¹„ìŠ¤ ì—°ê²° ëŒ€ê¸°
        run: |
          echo "MySQL ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          for i in {1..30}; do
            if mysqladmin ping -h127.0.0.1 -P3306 -uroot -proot --silent; then
              echo "âœ… MySQL ì—°ê²° ì„±ê³µ!"
              break
            fi
            echo "MySQL ì—°ê²° ëŒ€ê¸° ì¤‘... ($i/30)"
            sleep 2
          done

      # ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (í†µí•© í…ŒìŠ¤íŠ¸ í¬í•¨)
      - name: ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew clean test jacocoTestReport -Pprofile=test

      # PRì— í†µí•© í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ë¥¼ ì½”ë©˜íŠ¸ë¡œ ì¶”ê°€
      - name: ğŸ“Š í†µí•© í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì½”ë©˜íŠ¸
        uses: madrapps/jacoco-report@v1.7.1
        with:
          paths: ${{ github.workspace }}/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 55
          min-coverage-changed-files: 55
          title: "ğŸ“Š í†µí•© í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸"
          update-comment: true
          pass-emoji: 'ğŸ'
          fail-emoji: 'ğŸ”´'
          skip-if-no-changes: false
          coverage-overall-threshold: 90
          coverage-changed-files-threshold: 80
      
      - name: ğŸ’¾ í†µí•© í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: integration-test-coverage-report
          path: build/reports/
      
      - name: ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: ./gradlew clean build -x test -Pprofile=test